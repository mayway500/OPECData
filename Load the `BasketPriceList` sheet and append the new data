import pandas as pd
import json
import requests
import os
import numpy as np
# Removed google.colab.drive import
from datetime import datetime
from urllib.parse import quote
import xml.etree.ElementTree as ET
from bs4 import BeautifulSoup
# Removed google.colab.data_table import
from datetime import timedelta, date
from sklearn.linear_model import LinearRegression
import urllib.request
from html_table_parser.parser import HTMLTableParser
from furl import furl


from datetime import datetime, timedelta
import pandas as pd
import re

# Load OilpriceChart (gid=0) without a header to access raw cells
gid_oilprice_chart = 0
oilprice_chart_df = load_google_sheet_as_df(sheet_id, gid_oilprice_chart, header=None)

# Initialize price_val and date_val to None
price_val = None
date_val = None

if not oilprice_chart_df.empty:
    # Assuming 1-indexed Google Sheet rows/columns, so row 10 is index 9, col C is index 2, col F is index 5
    try:
        # Convert price to numeric, handling potential non-numeric values gracefully
        extracted_price = pd.to_numeric(oilprice_chart_df.iloc[9, 2], errors='coerce')

        date_str_raw = str(oilprice_chart_df.iloc[9, 5])
        parsed_date = pd.to_datetime(date_str_raw, errors='coerce')

        if pd.isna(extracted_price):
            print("Warning: Could not extract a valid numeric price from OilpriceChart at row 10, column C.")
            print(f"Extracted raw price value: {oilprice_chart_df.iloc[9, 2]}")
        else:
            price_val = extracted_price

        if pd.isna(parsed_date):
            # Attempt to parse '(X days Delay)' pattern
            match = re.search(r'\((\d+)\s+days\s+Delay\)', date_str_raw)
            if match:
                delay_days = int(match.group(1))
                date_val = (datetime.now() - timedelta(days=delay_days)).date()
                print(f"Derived Date from delay: {date_val}")
            else:
                print(f"Warning: Could not extract a valid date from '{date_str_raw}'. Using today's date.")
                date_val = datetime.now().date() # Use today's date
        else:
            date_val = parsed_date.date() # Ensure it's just a date object

        if price_val is not None and date_val is not None:
            print(f"Extracted Price (10C): {price_val}")
            print(f"Assigned Date: {date_val}")
        else:
            print("Could not extract both valid price and a date.")

    except IndexError:
        print("Error: Row 10 or specified columns not found in OilpriceChart data. The sheet might be empty or have fewer rows/columns.")
        price_val = None
        date_val = None
else:
    print("OilpriceChart DataFrame is empty. Cannot extract data.")
    price_val = None
    date_val = None









# Load BasketPriceBase (gid=731911369) assuming it has a header
gid_basket_price_base = 731911369
basket_price_base_df = load_google_sheet_as_df(sheet_id, gid_basket_price_base)

if not basket_price_base_df.empty and price_val is not None and date_val is not None:
    # Assuming the BasketPriceBase has 'Date' and 'Price' columns. 
    # You might need to adjust column names if they are different in your sheet.
    new_row = pd.DataFrame([{'Date': date_val, 'Price': price_val}])

    # Ensure 'Date' column is datetime type before appending if needed
    if 'Date' in basket_price_base_df.columns:
        basket_price_base_df['Date'] = pd.to_datetime(basket_price_base_df['Date'], errors='coerce')
    
    basket_price_base_df = pd.concat([basket_price_base_df, new_row], ignore_index=True)
    print("Updated BasketPriceBase DataFrame (in memory):")
    display(basket_price_base_df.tail())
elif basket_price_base_df.empty:
    print("BasketPriceBase DataFrame is empty. Cannot append data.")
else:
    print("Cannot append data as price or date extraction failed.")






